<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>LED strip programming</title>

		<style>
			body {
				font-family: Monospace;
				font-size: 11px;
				background-color: lightgray;
				tab-size: 4;
			}

			input {
				font-family: Monospace;
				font-size: 11px;
			}

			select {
				font-family: Monospace;
				font-size: 11px;
			}

			textarea {
				font-family: Monospace;
				font-size: 11px;
			}

			#codeArea {
				width: 600pt;
				height: 400pt;
			}

			.dot {
				height: 16px;
				width: 16px;
				background-color: black;
				border-radius: 50%;
				display: inline-block;
			}

			#logContainer {
				padding: 10px;
				border: 1px solid silver;
			}

			#log {
				resize: none;
				width: 100%;
				height: 100%;
				padding: 10px;
				margin: -10px;
			}

			table, th, td {
				border: 1px solid black;
			}

			th, td {
				padding: 10px;
			}
		</style>
	</head>

	<body>
		<script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js"></script>
		<script>
			function startWebsocket() {
				window.ws = new WebSocket('wss://coons.club/ledprg/ws');
				ws.onmessage = function(message) {
					console.log(message.data);
				}
				ws.onopen = function (event) {
					var connectionIndicator = document.getElementById('connectionIndicator');
					connectionIndicator.style.backgroundColor = 'red';
				};
				ws.onclose = function () {
					var connectionIndicator = document.getElementById('connectionIndicator');
					connectionIndicator.style.backgroundColor = 'gray';
					setTimeout(function () {
						startWebsocket()
					}, 1000);
				};
			}
			startWebsocket()

			function log_timestamp() {
				var d = new Date();
				return '' +
					d.getDate().toString().padStart(2, '0') + '-' +
					d.getMonth().toString().padStart(2, '0') + '-' +
					d.getFullYear().toString().substr(2, 2) + ' ' +
					d.getHours().toString().padStart(2, '0') + ':' +
					d.getMinutes().toString().padStart(2, '0') + ':' +
					d.getSeconds().toString().padStart(2, '0') + '.' +
					d.getMilliseconds().toString().padStart(3, '0');
			}

			document.addEventListener('DOMContentLoaded', function() {
				var system_console_log = console.log;
				var system_console_warn = console.error;
				var system_console_error = console.error;
				var logger = document.getElementById('log');
				try {
					codeArea.setValue(localStorage.getItem('code'));
				} catch (e) {

				}
				console.log = function (message) {
					logger.value += 'I ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_log(message);
				};
				console.warn = function (message) {
					logger.value += 'W ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_warn(message);
				};
				console.error = function (message) {
					logger.value += 'E ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_error(message);
				};
			});
			window.addEventListener('beforeunload', function(event) {
				try {
					localStorage.setItem('code', codeArea.getValue());
				} catch(e) {

				}
			});
		</script>
		<table>
			<tr>
				<td id="codeArea"></td>
				<td rowspan="2">
					<span id="connectionIndicator" class="dot"></span>
					<button type="button" onclick="ws.send(codeArea.getValue())"> > Run </button>
					<p>Examples:</p>
					<hr>
<p style="white-space: pre">-- random flashing
local result = {}

for i = 1, PIX_NUM, 1 do
	table.insert(result, math.random(0x00, 0x0f)) -- red
	table.insert(result, math.random(0x00, 0x0f)) -- green
	table.insert(result, math.random(0x00, 0x0f)) -- blue
end

return result, 200
</p>
					<hr>
<p style="white-space: pre">-- running colors
local result = {}
local third = PIX_NUM / 3
local rfocus = PERIOD_COUNTER % PIX_NUM
local gfocus = (PERIOD_COUNTER + third) % PIX_NUM
local bfocus = (PERIOD_COUNTER + third * 2) % PIX_NUM

for i = 0, PIX_NUM - 1, 1 do
	table.insert(result, math.floor(255 /
		(math.abs(i - rfocus) + 1))) -- red
	table.insert(result, math.floor(255 /
		(math.abs(i - gfocus) + 1))) -- green
	table.insert(result, math.floor(255 /
		(math.abs(i - bfocus) + 1))) -- blue
end

return result, 50
</p>
					<hr>
<p style="white-space: pre">-- smooth running colors
local result = {}
local third = PIX_NUM / 3
local rfocus = PERIOD_COUNTER % PIX_NUM
local gfocus = (PERIOD_COUNTER + third) % PIX_NUM
local bfocus = (PERIOD_COUNTER + third * 2) % PIX_NUM

function color(focus, i)
    local rdistance = math.abs(i - focus)
    local ldistance = PIX_NUM - rdistance
    return math.floor(255 / (math.min(rdistance, ldistance) + 1))
end

for i = 0, PIX_NUM - 1, 1 do
	table.insert(result, color(rfocus, i)) -- red
	table.insert(result, color(gfocus, i)) -- green
	table.insert(result, color(bfocus, i)) -- blue
end

return result, 50
</p>
				</td>
			</tr>
			<tr>
				<td id="logContainer">
					<textarea id="log" rows="16" readonly></textarea>
				</td>
			</tr>
		</table>
		<script>
			ace.config.set('basePath', 'https://pagecdn.io/lib/ace/1.4.12');
			window.codeArea = ace.edit('codeArea');
			// codeArea.setTheme('ace/theme/monokai');
			codeArea.session.setMode('ace/mode/lua');
		</script>
	</body>
</html>
