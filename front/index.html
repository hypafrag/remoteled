<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>LED strip programming</title>

		<style>
			body {
				display: grid;
				grid-template-areas:
					"a b"
					"c b";
				grid-template-rows: 60% 1fr;
				grid-template-columns: 60% 1fr;
				grid-gap: 4pt;
				height: 100vh;
				margin: 0;
			}

			body {
				font-family: Monospace;
				font-size: 11px;
				background-color: lightgray;
				tab-size: 4;
			}

			textarea {
				font-family: Monospace;
				font-size: 11px;
			}

			.dot {
				height: 16px;
				width: 16px;
				background-color: black;
				border-radius: 50%;
				display: inline-block;
			}

			#codeArea {
				margin: 1px;
			}

			textarea {
				resize: none;
				border: none;
				outline: none;
				padding: 0;
				margin: 1px;
			}
		</style>
	</head>

	<body>
		<script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js"></script>
		<script>
			function copyToEditor(example) {
				let p = document.getElementById(example);
				codeArea.setValue(p.textContent, -1);
			}

			function copyToClipboard(example) {
				let p = document.getElementById(example);
				let range = document.createRange();
				range.selectNode(p);
				window.getSelection().removeAllRanges();
				window.getSelection().addRange(range);
				document.execCommand("copy");
			}

			function startWebsocket() {
				window.ws = new WebSocket('wss://coons.club/ledprg/ws');
				ws.onmessage = function(message) {
					console.log(message.data);
				}
				ws.onopen = function (event) {
					var connectionIndicator = document.getElementById('connectionIndicator');
					connectionIndicator.style.backgroundColor = 'red';
				};
				ws.onclose = function () {
					var connectionIndicator = document.getElementById('connectionIndicator');
					connectionIndicator.style.backgroundColor = 'gray';
					setTimeout(function () {
						startWebsocket()
					}, 1000);
				};
			}
			startWebsocket()

			function log_timestamp() {
				var d = new Date();
				return '' +
					d.getDate().toString().padStart(2, '0') + '-' +
					d.getMonth().toString().padStart(2, '0') + '-' +
					d.getFullYear().toString().substr(2, 2) + ' ' +
					d.getHours().toString().padStart(2, '0') + ':' +
					d.getMinutes().toString().padStart(2, '0') + ':' +
					d.getSeconds().toString().padStart(2, '0') + '.' +
					d.getMilliseconds().toString().padStart(3, '0');
			}

			document.addEventListener('DOMContentLoaded', function() {
				var system_console_log = console.log;
				var system_console_warn = console.error;
				var system_console_error = console.error;
				var logger = document.getElementById('log');
				try {
					let code = localStorage.getItem('code');
					if (code === null || code === "") {
						copyToEditor('randomFlashingP')
					} else {
						codeArea.setValue(code, -1);
					}
				} catch (e) {

				}
				console.log = function (message) {
					logger.value += 'I ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_log(message);
				};
				console.warn = function (message) {
					logger.value += 'W ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_warn(message);
				};
				console.error = function (message) {
					logger.value += 'E ' + log_timestamp() + ' ';
					logger.value += message + '\n';
					logger.scrollTop = logger.scrollHeight;
					system_console_error(message);
				};
			});
			window.addEventListener('beforeunload', function(event) {
				try {
					localStorage.setItem('code', codeArea.getValue());
				} catch(e) {

				}
			});
		</script>
		<div id="codeArea" style="grid-area: a;"></div>
		<div style="grid-area: b; overflow-y: auto; overflow-x: hidden;">
			<hr>
			<span id="connectionIndicator" class="dot"></span>
			<button type="button" onclick="ws.send(codeArea.getValue())"> &#x23E9; Run </button>
<!-- ----------------------------------------------------------------------------------------- -->
<p>Examples:</p>

<hr>

<p id="randomFlashingP" style="white-space: pre">-- random flashing
local result = {}

for i = 1, PIX_NUM, 1 do
	table.insert(result, math.random(0x00, 0x0f)) -- red
	table.insert(result, math.random(0x00, 0x0f)) -- green
	table.insert(result, math.random(0x00, 0x0f)) -- blue
end

return result, 200
</p>
<button type="button" onclick="copyToEditor('randomFlashingP')"> Copy to editor </button>
<button type="button" onclick="copyToClipboard('randomFlashingP')"> Copy to clipboard </button>

<hr>

<p id="turnOffP" style="white-space: pre">-- turn off
return RESULT_OFF
</p>
<button type="button" onclick="copyToEditor('turnOffP')"> Copy to editor </button>
<button type="button" onclick="copyToClipboard('turnOffP')"> Copy to clipboard </button>
	
<hr>
	
<p id="runningColorsP" style="white-space: pre">-- running colors
local result = {}
local third = PIX_NUM / 3
local rfocus = PERIOD_COUNTER % PIX_NUM
local gfocus = (PERIOD_COUNTER + third) % PIX_NUM
local bfocus = (PERIOD_COUNTER + third * 2) % PIX_NUM

for i = 0, PIX_NUM - 1, 1 do
	table.insert(result, math.floor(255 /
		(math.abs(i - rfocus) + 1))) -- red
	table.insert(result, math.floor(255 /
		(math.abs(i - gfocus) + 1))) -- green
	table.insert(result, math.floor(255 /
		(math.abs(i - bfocus) + 1))) -- blue
end

return result, 50
</p>
<button type="button" onclick="copyToEditor('runningColorsP')"> Copy to editor </button>
<button type="button" onclick="copyToClipboard('runningColorsP')"> Copy to clipboard </button>

<hr>

<p id="smoothRunningColorP" style="white-space: pre">-- smooth running colors
local result = {}
local third = PIX_NUM / 3
local rfocus = PERIOD_COUNTER % PIX_NUM
local gfocus = (PERIOD_COUNTER + third) % PIX_NUM
local bfocus = (PERIOD_COUNTER + third * 2) % PIX_NUM

function color(focus, i)
    local rdistance = math.abs(i - focus)
    local ldistance = PIX_NUM - rdistance
    return math.floor(255 / (math.min(rdistance, ldistance) + 1))
end

for i = 0, PIX_NUM - 1, 1 do
	table.insert(result, color(rfocus, i)) -- red
	table.insert(result, color(gfocus, i)) -- green
	table.insert(result, color(bfocus, i)) -- blue
end

return result, 50
</p>
<button type="button" onclick="copyToEditor('smoothRunningColorP')"> Copy to editor </button>
<button type="button" onclick="copyToClipboard('smoothRunningColorP')"> Copy to clipboard </button>
<!-- ----------------------------------------------------------------------------------------- -->
		</div>
		<textarea id="log" style="grid-area: c;" readonly></textarea>
		<script>
			ace.config.set('basePath', 'https://pagecdn.io/lib/ace/1.4.12');
			window.codeArea = ace.edit('codeArea');
			// codeArea.setTheme('ace/theme/monokai');
			codeArea.session.setMode('ace/mode/lua');
		</script>
	</body>
</html>
